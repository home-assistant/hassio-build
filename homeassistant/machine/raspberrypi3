FROM homeassistant/armhf-homeassistant:%%VERSION%%

LABEL io.hass.machine raspberrypi3

RUN apk --no-cache add raspberrypi raspberrypi-libs raspberrypi-dev usbutils

##
# Set symlinks for raspberry pi binaries.
RUN ln -sv /opt/vc/bin/raspistill /usr/local/bin/raspistill \
    && ln -sv /opt/vc/bin/raspivid /usr/local/bin/raspivid \
    && ln -sv /opt/vc/bin/raspividyuv /usr/local/bin/raspividyuv \
    && ln -sv /opt/vc/bin/raspiyuv /usr/local/bin/raspiyuv

##
# Build libcec with RPi support for HDMI-CEC
ADD https://github.com/Pulse-Eight/libcec/archive/libcec-4.0.2.tar.gz \
        https://github.com/Pulse-Eight/platform/archive/p8-platform-2.1.0.1.tar.gz \
        ./
RUN apk add --no-cache --virtual build-dependencies \
        build-base cmake eudev-dev \
    && tar xvzf p8-platform-2.1.0.1.tar.gz \
    && rm p8-platform-*.tar.gz && mv platform* platform \
    && mkdir platform/build \
    && cd platform/build \
    && cmake -DCMAKE_INSTALL_PREFIX:PATH=/usr/local .. \
    && make \
    && make install \
    && cd - \
    && tar xvzf libcec-4.0.2.tar.gz && rm libcec-*.tar.gz \
    && mv libcec* libcec \
    && mkdir libcec/build \
    && cd libcec/build \
    && cmake -DCMAKE_INSTALL_PREFIX:PATH=/usr/local \
        -DRPI_INCLUDE_DIR=/opt/vc/include \
        -DRPI_LIB_DIR=/opt/vc/lib \
        -DPYTHON_LIBRARY="/usr/lib/libpython3.6m.so" \
        -DPYTHON_INCLUDE_DIR="/usr/include/python3.6m" .. \
    && make -j4 \
    && make install \
    && apk del build-dependencies \
    && cd - && rm -rf platform && rm -rf libcec

ENV LD_LIBRARY_PATH=/opt/vc/lib:${LD_LIBRARY_PATH}
